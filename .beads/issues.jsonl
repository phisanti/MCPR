{"id":"MCPR-1bv","title":"Harmonise inspect_object and view tool boundaries","description":"## Problem\n\nThe \\`InspectionEngine\\` in \\`new_components/\\` accumulated responsibilities that overlap with the existing production \\`view\\` tool. Before \\`inspect_object\\` ships (see MCPR-69f), we need a clean boundary so agents know which tool to call and there is no duplicated logic.\n\n**Design principle**: \\`view\\` = system/session information. \\`inspect_object\\` = deep analysis of a specific R object.\n\n## Truly overlapping capabilities\n\nThese features exist in both \\`view\\` and \\`InspectionEngine\\` and do the same thing:\n\n| Capability | \\`view\\` | \\`InspectionEngine\\` | Verdict |\n|---|---|---|---|\n| **Last error** | \\`view(\"last_error\")\\` — formats error message + traceback | \\`@last_error\\` → \\`inspect_last_error()\\` — error message + rlang trace | **Overlap.** Same data, two entry points. Keep in \\`view\\`. Remove from \\`inspect_object\\`. |\n| **Terminal history** | \\`view(\"terminal\")\\` — recent console output | \\`@terminal\\` → \\`inspect_terminal_output()\\` — recent commands + output | **Overlap.** Same data. Keep in \\`view\\`. Remove from \\`inspect_object\\`. |\n| **Warnings** | \\`view(\"warnings\")\\` — recent warnings | Part of terminal inspection output | **Overlap.** Keep in \\`view\\`. Remove from \\`inspect_object\\`. |\n| **Installed packages** | \\`view(\"installed_packages\")\\` — package list | \\`@installed_packages\\` → \\`inspect_installed_packages()\\` — same list with more detail | **Overlap.** Keep in \\`view\\`. Remove from \\`inspect_object\\`. |\n\n## Ambiguously overlapping capabilities\n\nThese touch similar domains but serve different purposes. Need design decisions:\n\n| Capability | \\`view\\` | \\`InspectionEngine\\` | Analysis |\n|---|---|---|---|\n| **Global env object listing** | \\`view(\"session\")\\` — lists objects in \\`.GlobalEnv\\` with class/dims summary (shallow) | \\`@globalenv\\` → \\`inspect_env(\".GlobalEnv\")\\` — lists environment contents with parent tracking (deeper) | **Ambiguous.** \\`view(\"session\")\\` is \"what objects exist?\" (catalog). \\`inspect_env\\` is \"what's inside this environment?\" (deep dive). Proposal: \\`view(\"session\")\\` keeps the shallow catalog. \\`inspect_object\\` can inspect a specific environment if passed by name, but does NOT replicate the global listing. |\n| **Loaded/attached packages** | \\`view(\"search_path\")\\` — shows \\`search()\\` output | \\`@attached_packages\\` / \\`@loaded_packages\\` → lists with version info | **Ambiguous.** \\`view\\` shows the namespace hierarchy. InspectionEngine shows package details. Proposal: keep both in \\`view\\` (it's system info). If an agent wants to inspect a specific package object, that's \\`inspect_object\\`. |\n\n## Capabilities that are NOT overlapping\n\nThese exist only in one tool and should stay there:\n\n- **\\`inspect_object\\` only**: R object deep analysis (data frames, vectors, lists, factors, matrices, functions, S3/S4/R6, models)\n- **\\`inspect_object\\` only**: \\`@last_value\\` (inspects the last computed R object — this IS an object, fits inspect)\n- **\\`inspect_object\\` only**: \\`?topic\\` help pages, \\`{package}\\` package inspection\n- **\\`view\\` only**: \\`view(\"workspace\")\\` filesystem/directory structure\n- **\\`view\\` only**: \\`view(\"search_path\")\\` namespace hierarchy\n\n## Proposed resolution\n\n### Remove from \\`inspect_object\\` (keep in \\`view\\`)\n- \\`@last_error\\` → agent should use \\`view(\"last_error\")\\`\n- \\`@terminal\\` → agent should use \\`view(\"terminal\")\\`\n- \\`@installed_packages\\`, \\`@attached_packages\\`, \\`@loaded_packages\\` → agent should use \\`view(\"installed_packages\")\\` or \\`view(\"search_path\")\\`\n- Warnings → agent should use \\`view(\"warnings\")\\`\n\n### Keep in \\`inspect_object\\`\n- \\`@last_value\\` — this inspects an R object, not session state\n- All R object type inspections (data frame, vector, list, factor, matrix, function, S3/S4/R6)\n- \\`?topic\\` help — could go either way, but it's \"inspect this thing\" not \"show system state\"\n- \\`./path\\` file inspection — borderline, but useful as \"inspect this file's contents\"\n\n### Update tool descriptions\n- \\`view\\` description should say: \"System and session information — use for terminal, errors, packages, workspace, warnings\"\n- \\`inspect_object\\` description should say: \"Deep analysis of R objects — use for data frames, functions, models, lists, or any named object. Use \\`view\\` for session state.\"\n\n## Acceptance criteria\n\n- [ ] No duplicated functionality between the two tools\n- [ ] Clear tool descriptions that guide agents to the right tool\n- [ ] Special syntax routing (\\`@\\`, \\`?\\`, \\`./\\`) reflects the agreed boundaries\n- [ ] Agents can inspect an environment object if they pass its name, but global env catalog stays in \\`view(\"session\")\\`\n\n## Dependencies\n\n- Blocked by MCPR-69f (implement inspect_object) — the harmonisation can happen during or right after implementation","status":"closed","priority":1,"issue_type":"task","owner":"tisalon@outlook.com","created_at":"2026-02-18T15:15:49.505122+01:00","created_by":"Cano-Muniz, Santiago","updated_at":"2026-02-19T09:40:39.481126+01:00","closed_at":"2026-02-19T09:40:39.481126+01:00","close_reason":"Closed","labels":["design","inspection","tools"],"dependencies":[{"issue_id":"MCPR-1bv","depends_on_id":"MCPR-69f","type":"blocks","created_at":"2026-02-18T15:15:54.451557+01:00","created_by":"Cano-Muniz, Santiago"}]}
{"id":"MCPR-69f","title":"Implement inspect_r_object as production MCP tool","description":"## Summary\n\nPromote the \\`inspect_object\\` tool from \\`new_components/tools/tool-inspect_object.R\\` to a production MCP tool in \\`inst/tool-inspect_object.R\\`. The R6 class \\`ObjectInspector\\` and its MCP wrapper are currently skeleton implementations (methods contain design comments but no executable code). This issue covers implementing the actual logic and deploying the tool.\n\n## Current state\n\n- **\\`new_components/tools/tool-inspect_object.R\\`**: Contains \\`ObjectInspector\\` R6 class with 20+ private methods — all are stubs with implementation notes, no working code.\n- **\\`new_components/inspection-engine.R\\`**: Contains \\`InspectionEngine\\` R6 class with working dispatch logic for type detection and special syntax (\\`@last_value\\`, \\`?topic\\`, \\`./path\\`, etc.), plus several implemented methods (e.g. \\`inspect_installed_packages\\`). This is more mature but also mixes object inspection with session/filesystem concerns.\n- **MCP wrapper**: The \\`inspect_object(object_name)\\` function wrapper exists and handles object resolution + environment search. Needs the \\`ObjectInspector\\` internals to actually work.\n\n## Scope\n\nImplement \\`inspect_object\\` as a focused **R object inspection** tool. It takes an object name and returns a detailed, formatted analysis appropriate for an AI agent.\n\n**Key design constraint**: The MCP-facing function is argument-free beyond the object name: \\`inspect_object(object_name)\\`. The tool auto-detects the object type and applies the appropriate inspection. No format flags, no mode switches.\n\n### Object types to support (priority order)\n\n1. **Data frames / tibbles** — dimensions, column types, head/tail sample, summary stats, missing values\n2. **Vectors** (numeric, character, logical, etc.) — type, length, range/sample, unique count\n3. **Lists** — recursive structure, element types, names\n4. **Factors** — levels, frequencies, ordered flag\n5. **Matrices / arrays** — dimensions, type, sample\n6. **Functions** — formals, body preview, environment, source location\n7. **S3 objects** (lm, glm, etc.) — class, available methods, key summary fields\n8. **R6 objects** — class hierarchy, public/private methods and fields\n9. **S4 objects** — class hierarchy, slots, virtual class info\n10. **Formulas** (\\`~\\`) — response vs predictors, associated environment, variable names (\\`print()\\` just shows \\`y ~ x\\` which is insufficient)\n11. **Date/time** (\\`Date\\`, \\`POSIXct\\`, \\`POSIXlt\\`) — range, timezone, NA count, format. Generic handler gives okay output but misses the structured summary.\n12. **Environments** — parent chain, bindings, size\n\n### Implementation notes from btw reference analysis\n\nThe btw package (\\`references/btw/R/\\`) was used as a reference. Key takeaways for implementation with **zero new dependencies**:\n\n1. **Smart data frame output** — use base R only: \\`str()\\`, \\`summary()\\`, column types via \\`sapply(class, ...)\\`, dims, \\`head()\\`/\\`tail()\\` sample, \\`colSums(is.na(...))\\` for NA counts. No skimr/glimpse dependency needed.\n\n2. **Small-table detection** — if \\`nrow(x) \u003c= 20 \u0026\u0026 ncol(x) \u003c= 10\\`, render the actual data as formatted text; otherwise show structure + sample. Trivial, no dependency.\n\n3. **R6 public/private listing** — R6 objects expose \\`\\$public_methods\\`, \\`\\$public_fields\\`, etc. via the class generator. Inspect these directly. No dependency beyond R6 (already a dependency).\n\n4. **S4 slot analysis** — \\`slotNames()\\`, \\`slot()\\`, \\`isVirtualClass()\\` are all in the \\`methods\\` package (base R). No dependency.\n\n5. **Formulas** — \\`all.vars()\\` extracts variable names, \\`length(formula)\\` and indexing extracts response vs predictors, \\`environment(formula)\\` shows the associated env. All base R.\n\n6. **Date/time** — \\`range()\\`, \\`attr(x, \"tzone\")\\`, \\`format()\\` for POSIXct; \\`class()\\` distinguishes Date vs POSIXct vs POSIXlt. All base R.\n\n### What it should NOT do\n\nThis tool inspects **named R objects in the workspace**. It should NOT handle:\n- Session state queries (terminal history, warnings, errors) → that's \\`view\\`\n- File/directory browsing → that's \\`view(\"workspace\")\\` or filesystem tools\n- Package listing → that's \\`view(\"installed_packages\")\\`\n- Help pages → out of scope\n\n(See MCPR-1bv for boundary details with \\`view\\`.)\n\n## Files to create/modify\n\n| File | Change |\n|------|--------|\n| \\`inst/tool-inspect_object.R\\` | **New** — production tool with implemented \\`ObjectInspector\\` |\n| \\`tests/testthat/test-tool-inspect_object.R\\` | **New** — tests for all supported object types |\n| \\`new_components/tools/tool-inspect_object.R\\` | Archive or delete after promotion |\n\n## Design notes\n\n- Draw from the working dispatch logic in \\`InspectionEngine\\$inspect()\\` for type detection\n- Keep the R6 class (\\`ObjectInspector\\`) but implement the private methods\n- The MCP wrapper (\\`inspect_object(object_name)\\`) is already well-structured — keep it\n- Output should be plain text formatted for agent consumption (not markdown, not JSON)\n- Include memory usage (\\`object.size\\`) in the output header for all types\n- Zero new dependencies — everything implemented with base R + methods + R6","status":"closed","priority":2,"issue_type":"feature","owner":"tisalon@outlook.com","created_at":"2026-02-18T15:15:17.599767+01:00","created_by":"Cano-Muniz, Santiago","updated_at":"2026-02-19T09:40:36.6172+01:00","closed_at":"2026-02-19T09:40:36.6172+01:00","close_reason":"Closed","labels":["inspection","tools"]}
{"id":"MCPR-h0v","title":"Clarify that execute_r_code output is agent-only and invisible to the user","description":"## Problem\n\nThe `execute_r_code` tool description tells the agent it can \"run any valid R code and see the results,\" but it does not make clear that the output is **only visible to the agent** — the user never sees it. This causes agents to write code with user-facing commentary: section headers, explanatory comments, print statements meant for a human reader, etc. All of that is wasted tokens and noise.\n\n## Current behavior\n\nThe tool description in `inst/tool-execute_r_code.R` (line 11) says:\n\n\u003e \"Execute R code in the current R session. This tool allows you to run any valid R code and see the results...\"\n\nThere is no mention that the results go exclusively to the agent context, not to the user's screen.\n\nAs a result, agents tend to:\n- Add inline comments explaining what each step does (\"# Load the data\", \"# Now let's filter...\")\n- Print section dividers or headers meant for a human reader\n- Use cat()/message() for narration that nobody sees\n- Structure code as if it were a notebook or tutorial\n\n## Desired behavior\n\nUpdate the tool description to explicitly state:\n\n1. **Output is agent-only**: The results returned by this tool go into the agent's context window. The user does not see them.\n2. **Avoid unnecessary commentary**: Since the user cannot see the code output, there is no value in adding explanatory comments, section headers, or narrative print statements inside the executed code.\n3. **Be concise**: The agent should write minimal, efficient code. Comments should only be used when they help the agent itself understand complex logic on re-read, not for user explanation.\n\n## Proposed changes\n\n### `inst/tool-execute_r_code.R`\n\nUpdate the `@description` (line 11) to include language like:\n\n\u003e \"IMPORTANT: The output of this tool is only visible to you (the agent), NOT to the user. The user cannot see the code you execute or its results. Therefore: avoid unnecessary comments, section headers, or explanatory print statements in your code — they consume tokens without benefit. Write concise, efficient code. If you need to communicate results to the user, do so in your chat response after reviewing the tool output.\"\n\n## Acceptance criteria\n\n- [ ] Tool description explicitly states output is invisible to user\n- [ ] Description discourages comments/sections/narrative in executed code\n- [ ] Description advises the agent to communicate results via chat instead","status":"closed","priority":2,"issue_type":"task","owner":"tisalon@outlook.com","created_at":"2026-02-18T15:02:10.975684+01:00","created_by":"Cano-Muniz, Santiago","updated_at":"2026-02-19T05:51:25.026681+01:00","closed_at":"2026-02-19T05:51:25.026681+01:00","close_reason":"Closed","labels":["execute_r_code","tools","ux"]}
{"id":"MCPR-lke","title":"Render R plots inline in Claude Desktop via MCP Apps","description":"## Summary\n\nIntegrate MCPR with MCP Apps so that plots created during R interactions render directly inside the Claude Desktop UI, eliminating the need for external windows (e.g. XQuartz). This mirrors the VS Code R extension's embedded viewer flow while leveraging the new MCP Apps capability.\n\n## Motivation\n\n- **No more window switching**: Plots appear inline in Claude Desktop instead of popping up in XQuartz or an external device.\n- **Unified workspace**: Chat + plots + tools coexist in one interface. The R session is still managed by MCPR; only the visualization output is re-routed.\n- **Extensible UI**: The app surface can later support plot history, download, selection, and richer interactivity (e.g. httpgd, plotly).\n- **Cross-platform**: MCP Apps are host-managed, so this should work on macOS/Windows/Linux wherever Claude Desktop supports Apps.\n\n## How MCP Apps work\n\nPer the MCP Apps spec (https://modelcontextprotocol.io/docs/extensions/apps):\n\n1. Tools can include `_meta.ui.resourceUri` to point to a UI resource.\n2. UI is delivered from the server via `resources/list` and `resources/read` endpoints.\n3. The UI runs in a sandboxed iframe in the host and communicates with the server via postMessage-based JSON-RPC (recommended helper: @modelcontextprotocol/ext-apps).\n4. CSP can be declared using `_meta.ui.csp` for external scripts/styles.\n\n## Proposed Design\n\n### 1. Add a UI resource (MCP App)\n\n- Create `inst/mcp_app/index.html` — minimal HTML viewer for the latest plot.\n- Expose via MCP resource endpoints:\n  - `resources/list` returns a `ui://mcpr/plots` resource.\n  - `resources/read` serves the HTML for that resource.\n- The UI calls MCP tools via postMessage JSON-RPC.\n\n### 2. Link the UI via tool metadata\n\nAdd or annotate a tool with `_meta.ui.resourceUri`:\n\n```r\nannotations = list(\n  \"_meta\" = list(\n    ui = list(resourceUri = \"ui://mcpr/plots\"),\n    csp = list(\"script-src 'self' https://cdn.jsdelivr.net\", \"style-src 'self'\")\n  )\n)\n```\n\n### 3. Bridge plotting output into the UI\n\n**Option A — PNG snapshot (simple, reliable, recommended MVP)**\n- On each plot, write a PNG to a known temp location.\n- Expose a tool/resource endpoint returning the latest image as base64 via resources/read with mimeType: image/png.\n- The UI polls or subscribes and swaps the img source.\n\n**Option B — httpgd (interactive, future)**\n- Use httpgd to serve SVG plots with history/zoom.\n- The UI embeds the httpgd viewer (CSP permitting) or fetches SVG snapshots inline.\n- Enables plot history and interactive features.\n\n### 4. Extend MCPR server for MCP Apps resources\n\nCurrently resources/list returns an empty list. Extend to:\n- resources/list → include the UI resource(s).\n- resources/read → return UI HTML or plot images.\n- Ensure tool_as_json() serialization includes annotations so _meta.ui propagates correctly.\n\n## Files to create/modify\n\n- `R/mcpr-server.R` — Extend resources/list and add resources/read handler\n- `R/tool-definition.R` — Ensure annotations/_meta.ui pass through tool_as_json()\n- `inst/mcp_app/index.html` — **New** minimal plot viewer UI\n- `inst/tools/tool-create_plot.R` (or new tool) — Add _meta.ui.resourceUri annotation; optionally add get_latest_plot tool\n\n## Prior art\n\n- MCP Apps announcement: https://blog.modelcontextprotocol.io/posts/2026-01-26-mcp-apps/\n- MCP Apps spec: https://modelcontextprotocol.io/docs/extensions/apps\n- VS Code R extension viewer functions (.vsc.viewer, .vsc.browser, .vsc.view) — demonstrates plot capture and embedded viewer patterns\n\n## Open questions\n\n- Start with PNG snapshots or httpgd?\n- Auto-refresh the UI, or only update on tool call?\n- Support plot history or just latest plot?\n\n## Why feasible now\n\n- MCPR already negotiates MCP protocol versions and supports resources/list and tools/list.\n- MCP Apps spec explicitly supports UI delivery and tool-driven rendering.\n- The VS Code R extension proves the plot-capture-and-embed pattern works well.","status":"closed","priority":2,"issue_type":"feature","owner":"tisalon@outlook.com","created_at":"2026-02-18T14:57:23.916939+01:00","created_by":"Cano-Muniz, Santiago","updated_at":"2026-02-18T15:33:43.29302+01:00","closed_at":"2026-02-18T15:33:43.29302+01:00","close_reason":"Closed","labels":["enhancement","mcp-apps","plots"],"dependencies":[{"issue_id":"MCPR-lke","depends_on_id":"MCPR-wbe","type":"related","created_at":"2026-02-18T15:02:59.365735+01:00","created_by":"Cano-Muniz, Santiago"}],"comments":[{"id":1,"issue_id":"MCPR-lke","author":"Cano-Muniz, Santiago","text":"Merged into MCPR-wbe. All MCP Apps content is now part of the unified show_plot issue.","created_at":"2026-02-18T14:33:48Z"}]}
{"id":"MCPR-wbe","title":"show_plot: rename create_plot with target-based routing and multi-channel output","description":"## Summary\n\nRename \\`create_plot\\` to \\`show_plot\\` and add a \\`target\\` parameter (\\`\"user\"\\` or \\`\"agent\"\\`, defaulting to \\`\"user\"\\`) that controls the output channel. When targeting the user, the tool routes through the best available display channel — including MCP Apps for inline rendering in Claude Desktop.\n\n## Motivation\n\n- The current \\`create_plot\\` is agent-only but agents frequently misuse it to show plots to users.\n- A single tool with a \\`target\\` parameter is simpler than maintaining two separate tools.\n- MCP Apps (https://modelcontextprotocol.io/docs/extensions/apps) now enable embedding a plot viewer directly in Claude Desktop, eliminating XQuartz/external windows.\n- The VS Code R extension proves the plot-capture-and-embed pattern works well — we adapt it for multiple hosts.\n\n## Proposed design\n\n### Function signature\n\n\\`\\`\\`r\nshow_plot \u003c- function(expr, target = \"user\", width = 800, height = 600, format = \"png\",\n                      token_limit = 25000, warn_threshold = 20000)\n\\`\\`\\`\n\n### When \\`target = \"agent\"\\` (current create_plot behavior)\n\n- Render to temp file via httpgd or standard device\n- Return base64-encoded image for agent consumption\n- Apply token limits and optimization suggestions\n- Optimized defaults for token efficiency (600x450)\n\n### When \\`target = \"user\"\\` (default, new behavior)\n\nDisplay the plot to the user via the best available output channel, prioritized:\n\n1. **MCP Apps** (Claude Desktop) — if the host supports MCP Apps, render via \\`ui://mcpr/plots\\` resource. The plot appears inline in the Claude Desktop UI. See \"MCP Apps integration\" section below.\n2. **httpgd** — if an httpgd device is active, render through it. The host IDE (VS Code, Claude Desktop) picks up the URL. Mirrors \\`.vsc.attach\\` checking \\`if (identical(names(dev.cur()), \"httpgd\")) httpgd::hgd_url()\\`.\n3. **Standard print** — use \\`print(plot)\\` to the active graphics device. Works in terminal R, RStudio, and any environment with a default device.\n4. **File export fallback** — if headless, save to temp PNG and return the path.\n\nKey behaviors for user target:\n- Does NOT return base64 to the agent (avoids token waste)\n- Returns a short confirmation: \"Plot displayed to user via [method]\"\n- Uses full-size defaults (800x600)\n- No token_limit enforcement\n\n### Output channel detection\n\n\\`\\`\\`r\ndetect_output_channel \u003c- function() {\n  # 1. MCP Apps available?\n  if (mcp_apps_supported()) return(\"mcp_app\")\n  # 2. httpgd active?\n  if (identical(names(grDevices::dev.cur()), \"httpgd\")) return(\"httpgd\")\n  # 3. Interactive with display?\n  if (interactive() \u0026\u0026 (capabilities(\"X11\") || .Platform\\$OS.type == \"windows\" || Sys.getenv(\"RSTUDIO\") != \"\")) return(\"device\")\n  # 4. Headless fallback\n  return(\"file\")\n}\n\\`\\`\\`\n\n### Tool description\n\n\u003e \"Create and display R plots. By default (target='user'), the plot is shown to the user via the best available channel (MCP Apps viewer, httpgd, RStudio viewer, terminal device). Set target='agent' when YOU (the agent) need to see and analyze the plot as an image — returns a base64-encoded image optimized for token efficiency. The user does NOT see agent-targeted plots.\"\n\n---\n\n## MCP Apps integration (Claude Desktop inline plots)\n\nPer the MCP Apps spec (https://modelcontextprotocol.io/docs/extensions/apps):\n\n1. Tools can include \\`_meta.ui.resourceUri\\` to point to a UI resource.\n2. UI is delivered via \\`resources/list\\` and \\`resources/read\\` endpoints.\n3. UI runs in a sandboxed iframe, communicates via postMessage JSON-RPC.\n4. CSP declared via \\`_meta.ui.csp\\` for external scripts/styles.\n\n### MCP App UI resource\n\nCreate \\`inst/mcp_app/index.html\\` — minimal HTML viewer for the latest plot. Expose via:\n- \\`resources/list\\` -\u003e include \\`ui://mcpr/plots\\` resource\n- \\`resources/read\\` -\u003e serve the HTML\n\n### Tool metadata hook\n\nAnnotate \\`show_plot\\` with \\`_meta.ui.resourceUri\\`:\n\n\\`\\`\\`r\nannotations = list(\n  \"_meta\" = list(\n    ui = list(resourceUri = \"ui://mcpr/plots\"),\n    csp = list(\"script-src 'self' https://cdn.jsdelivr.net\", \"style-src 'self'\")\n  )\n)\n\\`\\`\\`\n\n### Plot delivery to UI\n\n**MVP: PNG snapshot**\n- On each plot, write PNG to a known temp location\n- Expose via \\`resources/read\\` with \\`mimeType: image/png\\`\n- UI polls or subscribes, swaps the img source\n\n**Future: httpgd**\n- Serve SVG plots with history/zoom\n- UI embeds httpgd viewer or fetches SVG snapshots inline\n\n### Server extensions needed\n\nCurrently \\`resources/list\\` returns empty. Extend to:\n- \\`resources/list\\` -\u003e include UI resource(s)\n- \\`resources/read\\` -\u003e return UI HTML or plot images\n- Ensure \\`tool_as_json()\\` serialization includes annotations so \\`_meta.ui\\` propagates\n\n---\n\n## Files to create/modify\n\n| File | Change |\n|------|--------|\n| \\`inst/tool-create_plot.R\\` | Rename to \\`inst/tool-show_plot.R\\`, add \\`target\\` param, add channel detection |\n| \\`inst/mcp_app/index.html\\` | **New** — minimal plot viewer UI for MCP Apps |\n| \\`R/mcpr-server.R\\` | Extend \\`resources/list\\` and add \\`resources/read\\` handler |\n| \\`R/tool-definition.R\\` | Ensure annotations/\\`_meta.ui\\` pass through \\`tool_as_json()\\` |\n| \\`tests/testthat/test-tool-create_plot.R\\` | Rename to \\`test-tool-show_plot.R\\`, tests for both targets and channel detection |\n\n## Prior art\n\n- MCP Apps announcement: https://blog.modelcontextprotocol.io/posts/2026-01-26-mcp-apps/\n- MCP Apps spec: https://modelcontextprotocol.io/docs/extensions/apps\n- VS Code R extension viewer functions (\\`.vsc.viewer\\`, \\`.vsc.browser\\`, \\`.vsc.attach\\`, \\`.vsc.view\\`) — source in \\`.active_plans/plots_to_claude.md\\`\n\n## Open questions\n\n- Start with PNG snapshots or httpgd for MCP Apps?\n- Auto-refresh the MCP App UI, or only update on tool call?\n- Support plot history in the MCP App or just latest plot?","status":"open","priority":2,"issue_type":"epic","owner":"tisalon@outlook.com","created_at":"2026-02-18T15:02:48.362892+01:00","created_by":"Cano-Muniz, Santiago","updated_at":"2026-02-19T06:43:27.013618+01:00","labels":["plots","tools","ux"]}
{"id":"MCPR-wbe.1","title":"Rename create_plot to show_plot with target param (user/agent)","description":"## Summary\n\nRename \\`create_plot\\` to \\`show_plot\\` and add a \\`target\\` parameter (\\`\"user\"\\` or \\`\"agent\"\\`, defaulting to \\`\"user\"\\`).\n\n## When \\`target = \"agent\"\\` (existing behavior)\n\nKeep the current \\`create_plot\\` logic as-is:\n- Render to temp file via httpgd or standard device\n- Return base64-encoded image for agent consumption\n- Apply token limits and optimization suggestions\n- Use agent-optimized defaults (600x450)\n\n## When \\`target = \"user\"\\` (default, new)\n\nSimple approach for MVP:\n- Execute the plot expression\n- Call \\`print()\\` on the result to send it to the active graphics device\n- Return a short confirmation: \"Plot displayed to user\"\n- Does NOT return base64 (avoids token waste)\n- Uses full-size defaults (800x600)\n\nThis is the simplest possible user-facing path — just \\`print(plot)\\` to whatever device is active. No channel detection logic yet.\n\n## Function signature\n\n\\`\\`\\`r\nshow_plot \u003c- function(expr, target = \"user\", width = 800, height = 600, format = \"png\",\n                      token_limit = 25000, warn_threshold = 20000)\n\\`\\`\\`\n\n## Tool description\n\n\u003e \"Create and display R plots. By default (target='user'), the plot is shown to the user via the active graphics device. Set target='agent' when YOU (the agent) need to see and analyze the plot — returns a base64-encoded image. The user does NOT see agent-targeted plots.\"\n\n## Files to modify\n\n| File | Change |\n|------|--------|\n| \\`inst/tool-create_plot.R\\` | Rename to \\`inst/tool-show_plot.R\\`, rename function, add \\`target\\` param with print-based user path |\n| \\`tests/testthat/test-tool-create_plot.R\\` | Rename to \\`test-tool-show_plot.R\\`, add tests for both targets |","status":"closed","priority":2,"issue_type":"feature","owner":"tisalon@outlook.com","created_at":"2026-02-19T06:43:43.611504+01:00","created_by":"Cano-Muniz, Santiago","updated_at":"2026-02-19T09:08:52.830984+01:00","closed_at":"2026-02-19T09:08:52.830984+01:00","close_reason":"Closed","labels":["plots","tools"],"dependencies":[{"issue_id":"MCPR-wbe.1","depends_on_id":"MCPR-wbe","type":"parent-child","created_at":"2026-02-19T06:43:43.612651+01:00","created_by":"Cano-Muniz, Santiago"}]}
{"id":"MCPR-wbe.2","title":"Add httpgd output channel for show_plot user target","description":"## Summary\n\nExtend the \\`target = \"user\"\\` path in \\`show_plot\\` to detect and prefer httpgd when available. This gives users interactive plot viewing in IDEs that support it (VS Code, RStudio with httpgd).\n\n## Prerequisite\n\nMCPR-wbe.1 (basic show_plot with print-based user path)\n\n## Design\n\nAdd channel detection to the user target path:\n\n\\`\\`\\`r\ndetect_output_channel \u003c- function() {\n  # 1. httpgd active?\n  if (identical(names(grDevices::dev.cur()), \"httpgd\")) return(\"httpgd\")\n  # 2. Interactive with display?\n  if (interactive()) return(\"device\")\n  # 3. Headless fallback\n  return(\"file\")\n}\n\\`\\`\\`\n\n### When httpgd is detected\n- Render through the httpgd device\n- Return confirmation with the httpgd URL: \"Plot displayed via httpgd at [url]\"\n- The host IDE picks up the URL automatically\n- Mirrors VS Code R extension pattern: \\`.vsc.attach\\` checks \\`if (identical(names(dev.cur()), \"httpgd\")) httpgd::hgd_url()\\`\n\n### When httpgd is NOT available\n- Fall back to the existing \\`print()\\` path from MCPR-wbe.1\n- Add file export fallback for headless environments (save PNG, return path)\n\n## Files to modify\n\n| File | Change |\n|------|--------|\n| \\`inst/tool-show_plot.R\\` | Add \\`detect_output_channel()\\`, httpgd rendering path, file fallback |\n| \\`tests/testthat/test-tool-show_plot.R\\` | Add tests for channel detection and httpgd path |","notes":"Reference: .agents_context/vscode-snippets.md — Contains VS Code R extension functions (.vsc.attach, .vsc.browser, .vsc.viewer, .vsc.view, .vsc.page_viewer) showing how httpgd integrates with VS Code. Key insight from .vsc.attach: plot_url is sent via 'if (identical(names(dev.cur()), \"httpgd\")) httpgd::hgd_url()'. The .vsc.browser function handles localhost proxy URIs for remote scenarios and routes to VS Code WebView or external browser.","status":"in_progress","priority":3,"issue_type":"feature","owner":"tisalon@outlook.com","created_at":"2026-02-19T06:43:58.662885+01:00","created_by":"Cano-Muniz, Santiago","updated_at":"2026-02-19T09:23:07.064847+01:00","labels":["httpgd","plots","tools"],"dependencies":[{"issue_id":"MCPR-wbe.2","depends_on_id":"MCPR-wbe","type":"parent-child","created_at":"2026-02-19T06:43:58.663624+01:00","created_by":"Cano-Muniz, Santiago"},{"issue_id":"MCPR-wbe.2","depends_on_id":"MCPR-wbe.1","type":"blocks","created_at":"2026-02-19T06:44:26.900811+01:00","created_by":"Cano-Muniz, Santiago"}]}
{"id":"MCPR-wbe.3","title":"Add MCP Apps channel for inline plots in Claude Desktop","description":"## Summary\n\nAdd a Claude Desktop output channel to \\`show_plot\\` via MCP Apps. When the host supports MCP Apps, plots render inline in the Claude UI instead of external windows.\n\n## Prerequisite\n\nMCPR-wbe.2 (httpgd channel with detect_output_channel infrastructure)\n\n## Design\n\n### Channel detection extension\n\nAdd MCP Apps as the highest-priority channel in \\`detect_output_channel()\\`:\n\n\\`\\`\\`r\ndetect_output_channel \u003c- function() {\n  if (mcp_apps_supported()) return(\"mcp_app\")  # NEW\n  if (identical(names(grDevices::dev.cur()), \"httpgd\")) return(\"httpgd\")\n  if (interactive()) return(\"device\")\n  return(\"file\")\n}\n\\`\\`\\`\n\n### MCP App UI resource\n\nPer the MCP Apps spec (https://modelcontextprotocol.io/docs/extensions/apps):\n\n- Create \\`inst/mcp_app/index.html\\` — minimal HTML plot viewer\n- Expose via \\`resources/list\\` as \\`ui://mcpr/plots\\`\n- Serve via \\`resources/read\\`\n- UI communicates with server via postMessage JSON-RPC\n\n### Tool metadata annotation\n\nAnnotate \\`show_plot\\` with \\`_meta.ui.resourceUri\\`:\n\n\\`\\`\\`r\nannotations = list(\n  \"_meta\" = list(\n    ui = list(resourceUri = \"ui://mcpr/plots\"),\n    csp = list(\"script-src 'self' https://cdn.jsdelivr.net\", \"style-src 'self'\")\n  )\n)\n\\`\\`\\`\n\n### Plot delivery\n\n**MVP: PNG snapshot**\n- On each plot, write PNG to a known temp location\n- Expose via \\`resources/read\\` with \\`mimeType: image/png\\`\n- UI polls or subscribes and swaps the img source\n\n**Future: httpgd integration**\n- Serve SVG with history/zoom via httpgd URL embedded in the MCP App iframe\n\n### Server extensions\n\n- \\`R/mcpr-server.R\\` — extend \\`resources/list\\` and add \\`resources/read\\` handler\n- \\`R/tool-definition.R\\` — ensure \\`_meta.ui\\` annotations pass through \\`tool_as_json()\\`\n\n## Files to create/modify\n\n| File | Change |\n|------|--------|\n| \\`inst/tool-show_plot.R\\` | Add mcp_app channel path, \\`mcp_apps_supported()\\` detection |\n| \\`inst/mcp_app/index.html\\` | **New** — minimal plot viewer UI |\n| \\`R/mcpr-server.R\\` | Extend \\`resources/list\\`, add \\`resources/read\\` handler |\n| \\`R/tool-definition.R\\` | Ensure annotations/\\`_meta.ui\\` pass through \\`tool_as_json()\\` |\n| Tests | Channel detection, resource endpoints, annotation serialization |\n\n## Open questions\n\n- Start with PNG snapshots or httpgd for the MCP App viewer?\n- Auto-refresh the UI, or only update on tool call?\n- Support plot history or just latest plot?\n\n## References\n\n- MCP Apps spec: https://modelcontextprotocol.io/docs/extensions/apps\n- MCP Apps announcement: https://blog.modelcontextprotocol.io/posts/2026-01-26-mcp-apps/\n- VS Code R extension patterns in \\`.active_plans/plots_to_claude.md\\`","status":"open","priority":3,"issue_type":"feature","owner":"tisalon@outlook.com","created_at":"2026-02-19T06:44:20.923978+01:00","created_by":"Cano-Muniz, Santiago","updated_at":"2026-02-19T06:44:20.923978+01:00","labels":["mcp-apps","plots","tools"],"dependencies":[{"issue_id":"MCPR-wbe.3","depends_on_id":"MCPR-wbe","type":"parent-child","created_at":"2026-02-19T06:44:20.925171+01:00","created_by":"Cano-Muniz, Santiago"},{"issue_id":"MCPR-wbe.3","depends_on_id":"MCPR-wbe.2","type":"blocks","created_at":"2026-02-19T06:44:26.978105+01:00","created_by":"Cano-Muniz, Santiago"}]}
